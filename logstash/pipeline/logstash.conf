input {
  # Recevoir les logs via HTTP
  http {
    port => 5044
    codec => json
  }
}

filter {
  # Ajouter des informations de temps
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Extraire les informations du workflow
  if [workflow_name] {
    mutate {
      add_field => {
        "source" => "github-actions"
        "pipeline_type" => "ci-cd"
      }
    }
  }

  # Marquer les erreurs
  if [conclusion] == "failure" {
    mutate {
      add_tag => ["error", "build-failed"]
    }
  } else if [conclusion] == "success" {
    mutate {
      add_tag => ["success", "build-passed"]
    }
  }

  # Calculer la durÃ©e du build
  if [started_at] and [completed_at] {
    ruby {
      code => "
        start_time = Time.parse(event.get('started_at'))
        end_time = Time.parse(event.get('completed_at'))
        duration = end_time - start_time
        event.set('duration_seconds', duration.round(2))
      "
    }
  }
}

output {
  # Envoyer vers Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "github-actions-%{+YYYY.MM.dd}"
  }

  # Afficher dans la console pour debug
  stdout {
    codec => rubydebug
  }
}